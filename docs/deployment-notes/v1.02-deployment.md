# Squibble v1.02 Deployment Notes

**Branch:** `feature/conversation-threading`
**Date:** February 2026

---

## Table of Contents
1. [Detailed Summary (Internal Reference)](#detailed-summary-internal-reference)
2. [App Store Release Notes](#app-store-release-notes)
3. [Production Migration Plan](#production-migration-plan)

---

## Detailed Summary (Internal Reference)

### New Features

#### Conversation Threading (Major Feature)
- **Chat View**: New "Chats" mode in History tab showing 1:1 conversations with friends
- **Thread View**: Tap a conversation to see full message history with doodles and text messages
- **Text Messages**: Send text messages within conversations (not just doodles)
- **Conversation Management**: Mute/unfriend from chat settings, unread badges, sorted by most recent
- **Real-time Updates**: Live message updates via Supabase Realtime subscriptions (up to 30 conversations)
- **Pagination**: "Load earlier messages" with smooth scroll position preservation (iOS 17+ optimized, iOS 16 fallback)

#### Reactions System
- **Emoji Reactions**: React to doodles with 6 emoji options (â¤ï¸ ğŸ˜‚ ğŸ˜® ğŸ˜¢ ğŸ”¥ ğŸ‘)
- **Aggregated Reactions**: Sender sees all recipient reactions on sent doodles (e.g., "ğŸ˜‚â¤ï¸2")
- **Toggle Behavior**: Tap same emoji to remove reaction
- **Visual Styling**: Frosted glass badges with subtle shadows

#### Sent Doodle Improvements
- **Visual Indicator**: Paperplane icon badge on sent doodles in grid
- **Recipients List**: See who received your doodle in detail view
- **Forward**: Forward doodles to additional friends
- **Aggregated Reactions**: See all reactions from all recipients

### UI/UX Improvements

#### Drawing Canvas
- Tap-to-dot drawing (single-point paths render as filled circles)
- Separate brush sizes for pen and eraser
- Trash clears strokes only (added separate "Remove Image" option)
- Save image button with haptic feedback and toast
- Custom color picker with 2D saturation-brightness picker, hue slider, and hex input

#### History View
- Grid/Chats toggle icon in header
- Hold-to-preview micro-interaction on grid items
- Inline ads (after 9 items, then every 12)
- Filter pills with subtle glass styling

#### Tab Bar & Headers
- Floating tab bar with blur effect and shadow
- Content scrolls behind tab bar
- Consistent header spacing (1.6x safe area) across all tabs
- Removed orange ambient gradient from background

#### Sheets & Modals
- Standardized glassy sheet backgrounds
- Standard navigation bar styling throughout
- Fixed double drag handle bugs

### Push Notifications
- Notifications for new doodles, text messages, reactions
- Notifications for friend requests and acceptances
- Respects muted conversation settings
- All notifications titled "Squibble"

### Profile Screen
- Friends list section with avatars
- Outgoing friend requests with cancel button
- Inline ad between activity and friends sections

### Performance & Caching
- Batch conversation query (eliminates N+1 queries)
- Reaction caching to reduce database fetches
- Recipients caching for sent doodles
- Debounced reaction loading (5-second window)
- Cache preservation on network errors

### Bug Fixes
- Chat scroll jumping when loading older messages
- Recipients seeing other recipients' reactions
- Reaction badge font size inconsistency
- Screen blanking on refresh
- Reaction disappearing after toggle

---

### Database Migrations (008-015)

| Migration | File | Description |
|-----------|------|-------------|
| 008 | `008_conversations_schema.sql` | Conversations schema (conversations, conversation_participants, thread_items tables) |
| 009 | `009_conversation_functions.sql` | Conversation functions (get_or_create_direct_conversation) |
| 010 | `010_backfill_conversations.sql` | Backfill existing doodles into conversations |
| 011 | `011_fix_rls_recursion.sql` | Fix RLS recursion issues |
| 012 | `012_text_message_function.sql` | Text message function (create_text_thread_item) |
| 013 | `013_reactions_schema.sql` | Reactions schema (reactions table, constraints) |
| 014 | `014_aggregated_reactions_function.sql` | Aggregated reactions function |
| 015 | `015_batch_conversation_query.sql` | Batch conversation query (get_conversations_with_metadata) |

### Edge Function Updates
- `send-push-notification`: Added support for text messages, reactions, mute checking

### Commit History

| Commit | Description |
|--------|-------------|
| `62f4294` | fix: Resolve P1 beta bugs and UX improvements |
| `193832a` | feat: Add conversation threading, reactions, and UI improvements |
| `77e8087` | feat: Refine tab bar and filter UI styling |
| `6147dfc` | fix: Align HistoryView header positioning with Profile/Home tabs |
| `db6c308` | feat: Add extra top padding to all tab headers for better spacing |
| `dcbff7d` | feat: Add inline ads, UI polish, and header adjustments |
| `aca598b` | feat: UI polish, push notifications, and sent doodle improvements |
| `b8eda4b` | feat: Add aggregated reactions, caching optimizations, and push notif updates |
| `2a90d1c` | fix: Resolve chat scroll jumping bugs and improve pagination UX |
| `e367d66` | feat: Add aggregated reactions, batch queries, and tracking improvements |
| `db245e0` | fix: Resolve reactions bugs in grid view |

---

## App Store Release Notes

```
What's New in Version 1.02:

ğŸ’¬ CHAT THREADING
â€¢ View your doodle history as conversations
â€¢ Send text messages alongside doodles
â€¢ Real-time message updates

â¤ï¸ REACTIONS
â€¢ React to doodles with emojis
â€¢ See who reacted to your sent doodles

âœï¸ DRAWING IMPROVEMENTS
â€¢ Tap to draw dots
â€¢ Separate brush sizes for pen and eraser
â€¢ New color picker with hex input
â€¢ Save drawings to your camera roll

ğŸ¨ UI POLISH
â€¢ Redesigned tab bar and headers
â€¢ Smoother animations and haptic feedback
â€¢ Friends list on your profile

ğŸ”” BETTER NOTIFICATIONS
â€¢ Get notified for messages and reactions
â€¢ Mute conversations you don't want alerts for

Plus bug fixes and performance improvements!
```

---

## Production Migration Plan

### Key Principle: Backwards Compatibility

The database migrations are **additive** (new tables, new functions) and don't modify existing tables that the current production app uses. This means you can safely deploy Supabase changes **before** the app update goes live.

---

### Deployment Timeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 1: SUPABASE (Deploy Now - Before App Store Submission)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**1. Run migrations 008-015 in order on production database**

```sql
-- Recommended: Run in Supabase SQL Editor one at a time
-- Or use: supabase db push (if using local CLI)
```

Migration order:
1. `008_conversations_schema.sql`
2. `009_conversation_functions.sql`
3. `010_backfill_conversations.sql`
4. `011_fix_rls_recursion.sql`
5. `012_text_message_function.sql`
6. `013_reactions_schema.sql`
7. `014_aggregated_reactions_function.sql`
8. `015_batch_conversation_query.sql`

**2. Deploy edge function update**

```bash
supabase functions deploy send-push-notification --project-ref YOUR_PROJECT_REF
```

**3. Verify deployment:**
- Check that new tables exist (conversations, thread_items, reactions, etc.)
- Test RPC functions in SQL editor
- Edge function logs show no errors

**WHY THIS IS SAFE:**
- New tables/functions don't affect existing app behavior
- Current production app doesn't call these endpoints
- Backfill migration (010) only creates data, doesn't modify existing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 2: APP STORE SUBMISSION                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

1. Merge `feature/conversation-threading` â†’ `main`
2. Update version number in Xcode (1.02)
3. Archive and submit to App Store
4. Wait for Apple review (typically 1-3 days)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 3: GO LIVE (When Apple Approves)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

1. Release the app update
2. Monitor:
   - Supabase dashboard for error logs
   - Edge function invocations
   - Push notification delivery rates

---

### Rollback Plan

If issues occur:

| Component | Rollback Action |
|-----------|-----------------|
| Edge Function | `supabase functions deploy send-push-notification` with previous version |
| Database | Migrations are additive; old app ignores new tables (no rollback needed) |
| App | Can't rollback App Store version; would need to submit hotfix |

---

### Pre-Deployment Checklist

```
â–¡ Backup production database (Supabase dashboard â†’ Settings â†’ Database â†’ Backups)
â–¡ Run migrations 008-015 on production
â–¡ Deploy edge function
â–¡ Test push notifications (send a test doodle)
â–¡ Verify conversations backfill completed (check conversations table has data)
â–¡ Merge branch to main
â–¡ Update version number
â–¡ Submit to App Store
```

---

### Post-Deployment Monitoring

**First 24 hours:** Watch Supabase logs for errors, especially:
- `get_conversations_with_metadata` RPC calls
- `send-push-notification` edge function errors
- RLS policy denials

**First week:** Monitor user feedback for:
- Missing messages/reactions
- Push notification issues
- Scroll/UI bugs on different iOS versions

---

## Files Changed Summary

### New Files
- `squibble/Models/Conversation.swift`
- `squibble/Models/ConversationParticipant.swift`
- `squibble/Models/ConversationSummary.swift`
- `squibble/Models/ThreadItem.swift`
- `squibble/Models/AggregatedReaction.swift`
- `squibble/Services/ConversationManager.swift`
- `squibble/Services/TrackingManager.swift`
- `squibble/Views/Conversations/ConversationListView.swift`
- `squibble/Views/Conversations/ConversationThreadView.swift`
- `squibble/Views/Conversations/ChatSettingsView.swift`
- `squibble/Views/Conversations/DoodleReactionOverlay.swift`
- `docs/migrations/008-015` (8 migration files)

### Modified Files
- `squibble/Services/SupabaseService.swift` - Added conversation/reaction queries
- `squibble/Services/RealtimeService.swift` - Added multi-conversation subscriptions
- `squibble/Services/DoodleManager.swift` - Added conversation-aware send
- `squibble/Services/NavigationManager.swift` - Added grid overlay state
- `squibble/Views/HistoryView.swift` - Added Grid/Chats toggle, reactions
- `squibble/Views/HomeView.swift` - Updated drawing features
- `squibble/Views/ProfileView.swift` - Added friends list
- `supabase/functions/send-push-notification/index.ts` - Added text/reaction notifications
